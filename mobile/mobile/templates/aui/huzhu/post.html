<!doctype html>
<html>
	<head>
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
		<meta content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
		<meta content="telephone=no" name="format-detection" />
		<meta content="address=no" name="format-detection" />
		<meta name="apple-mobile-web-app-capable" content="no" />
		<link rel="apple-touch-icon-precomposed" href="http://img0.zz91.com/zz91/images/logo.png" />
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="apple-touch-icon-precomposed" />
		<title>发布互助信息_ZZ91再生网</title>
		<link rel="stylesheet" type="text/css" href="http://static.m.zz91.com/aui/css/aui.css"/>
		<link rel="stylesheet" type="text/css" href="http://static.m.zz91.com/aui/css/common.css"/>
		<link rel="stylesheet" type="text/css" href="http://static.m.zz91.com/aui/css/aui-slider-full.css"/>
		<script type="text/javascript" src="http://static.m.zz91.com/aui/js/jquery.js"></script>
		<script type="text/javascript" src="http://static.m.zz91.com/aui/js/comm.js" ></script>
		<script type="text/javascript" src="http://static.m.zz91.com/layui/layui.js"></script>
		<style>
			body {
				width: 100%;
				height: 100%;
				font-size: 14px;
				padding-top: 15px;
				background-color: #f4f4f4;
			}
			.buy-show-box {
				display: block;
				background-color: #f2f2f2;
			}
			p.title {
				text-align:left;
				padding-left:10px;
				padding-top:10px;
			}
			textarea.buy-show {
				width: 100%;
				border: none;
				height: 150px;
				font-size: 14px;
				margin-bottom: 0;
				padding: 10px;
			}
			.handle {
				padding: 30px 8px 0px;
			}
			.handle-add {
				border: 1px dashed #e1e1e1;
				width: 23px;
				height: 23px;
				background: url(../../image/imageslist.png);
				background-size: 320px;
				background-position: -110px -234px;
			}
			.handle-add {
				border: 1px dashed #e1e1e1;
				width: 80px;
				height: 80px;
				text-align: center;
				line-height: 80px;
				background: #f2f2f2;
				float: left;
				margin: 0 20px 20px 0;
			}
			.img-kuang {
				position: relative;
				margin: 0 20px 20px 0;
				float: left;
				border: 1px dashed #e1e1e1;
				width: 80px;
				height: 80px;
			}
			.aui-icon-move {
				text-align: center;
				line-height: 20px;
				color: #fff
			}
			.delt-img {
				position: absolute;
				height: 20px;
				width: 20px;
				left: -10px;
				top: -10px;
				background: red;
				border-radius: 12px;
				box-shadow: 0px 0px 2px red;
			}
			.handle-add{
				font-size: 33px;
				color: #ccc;
			}
			.camediv{
				position: absolute; top: 50%; left: 50%; margin: -40px 0 0 -40px;
				width: 80px;
			}
			.aui-bar{
				position: fixed;
				z-index: 999;
				top: 0px;
			}
			.layui-upload-button{
				opacity: 0;
				width: 100%;
			}
			.layui-upload-iframe{
				display: none;
			}
			#postpic{
				width: 100%;
			}
			.showbigpic{
				width: 100%;
				background-color: #000;
				position: fixed;
				top: 0px;
				left: 0px;
				z-index: 9999;
				height: 100%;
				display: table;
				opacity: 1;
			}
			.showbigpic img{
				width: 100%;
			}
			.bigpic{
				display:table-cell;vertical-align: middle;*display: inline;*writing-mode: tb-rl;*text-align: center;*height: 100%;
			}
			.bigpic img{
				vertical-align: middle;*display: block;
			}
		</style>
	</head>
	<body>
		<header class="aui-bar aui-bar-nav aui-bar-primary">
	    	<a class="aui-pull-left" href="javascript:history.back(-1)">
		        <span class="aui-iconfont aui-icon-left"></span>
		    </a>
		    <div class="aui-title">我要发帖</div>
		    <a class="aui-pull-right" href="/">
		        <span class="aui-iconfont aui-icon-home"></span>
		    </a>
		</header>
		<div style="height:45px"></div>
		<section class="aui-card">
			<div class="handle">
				<span class="handle-add aui-iconfont aui-icon-cameraadd">
					<div class="camediv"></div>
				</span>
			</div>
			<form action="#" id="picForm" >
				<input type="file" id="cameraInput" name="uploadfile" style="opacity:0" accept="image/*">
			</form>
			<input type="hidden" name="piclist" id="piclist" value="">
			<div style="clear:both"></div>
			<!--<p class="aui-text-center title">
				详细描述
			</p>-->
			<div class="aui-line-x"></div>
			<div class="aui-form text-area">
				<textarea placeholder="在这里输入您想说的话题！" class="buy-show"></textarea>
			</div>
			<div class="aui-line-x"></div>
			<p class="title">
				选择你要发布到哪个版块
			</p>
			<div class="type-into">
				<label>
					<input class="aui-radio aui-radio-warning" type="radio" name="Fruit" value="106">
					<span class="aui-radio-name">商圈</span></label>
				<label>
					<input class="aui-radio aui-radio-warning" type="radio" name="Fruit" value="1">
					<span class="aui-radio-name">问答</span></label>
			</div>
			<div class="type-into">
				<label>
					<input class="aui-radio aui-radio-warning" type="radio" name="Fruit" value="2">
					<span class="aui-radio-name">社区</span></label>
				<label>
					<input class="aui-radio aui-radio-warning" type="radio" name="Fruit" value="122">
					<span class="aui-radio-name">招聘</span></label>
			</div>
			<div style="clear: both;"></div>
			<div class="aui-line-x"></div>
			<div class="see-contact">
				<div class="seedown clear">
					<label>
						<input class="aui-radio aui-radio-info" type="radio"  name="contactflag" id="contactflag"  value="1">
						<span class="aui-radio-name" style="color:#999">公开联系方式</span></label>
					<label>
						<input class="aui-radio aui-radio-info" type="radio" name="contactflag" id="contactflag" checked value="0">
						<span class="aui-radio-name" style="color:#999">隐藏联系方式</span></label>
				</div>
				<div class="advise" style="color:#ff0000;clear: both;padding: 10px;">
					建议您选择公开联系方式，让客户直接联系到你。
				</div>
			</div>
			<div class="aui-list-view-cell showcontact" style="border: solid 4px #FF9000;display: none;">
				<div class="aui-input-row" style="width: 100%">
					<a class="aui-arrow-right">
					<select name="showcontactnum" id="showcontactnum" class="aui-input" onchange="return selectshowcontact(this)" style="padding: 0px">
						<option value="300">￥ 300.00 / 月 </option>
						<option value="600">￥ 600.00 / 2个月</option>
						<option value="1800">￥ 1800.00 / 半年</option>
						<option value="3600">￥ 3600.00 / 一年</option>
					</select> </a>
				</div>
				<div class="aui-input-row" style="width: 100%">
					您的钱包余额：￥ <span class="balancenum">0.00</span>
				</div>
				<div class="aui-input-row nomeny" style="width: 100%">
					<span style="color:red">您的钱包余额不足</span><a class="aui-btn aui-btn-danger chongzhi" style="margin-left: 10px">立即充值</a>
				</div>
			</div>
		</section>
		<div class="bigpicbox" style="display: none;">
			<div class="showbigpic">
				<div class="aui-slider-close" tapmode onclick="closeopenpic()">关闭</div>
				<div class="bigpic"></div>
			</div>
		</div>
		<div style="color:#ff0000;padding:10px">发帖审核通过后即可获得 0.5元再生钱包</div>
		<section class="aui-content-padded">
			<div class="aui-btn aui-btn-block aui-btn-info handle-into" style="background-color:#01ba2e;border:none">
				提交问题
			</div>
		</section>
	</body>
	<script type="text/javascript">
		var photoBrowser;
		var postflag=true;
		var imagesList = [];
		var videoPlayer;
		function formDataUpLoad(file){
			//var data = new FormData($('#picForm')[0]);
			//创建FormData对象
	        var data = new FormData();
	        //为FormData对象添加数据
	        //
	        $.each($('#cameraInput')[0].files, function(i, file) {
	            data.append('file', file);
	        });
			var thisBtn = $(".handle-add");
			layer.load(2);
			$.ajax({
				url : "/huzhu_upload/?source=bbs_post",
				type : 'POST',
				contentType: false, //必须
				processData: false, //必须
				traditional: true,
				data: data,
				success: function(res) {
					res=JSON.parse(res)
					var imginfo = "";
					if (res.err=="login"){
						layer.msg('登录超时，请重新登录再发布信息！');
						window.location='/login/?done='+window.href;
						return;
					}
					if (res.err=="true"){
						layer.msg(res.errkey)
						return;
					}
					$.each(res.piclist, function(i, item) {
						var videopath=item.databasepath;
						var pic=item.path;
						if (item.mediatype=="video"){
							pic="http://static.m.zz91.com/image/video.png";
						}
						imginfo += '<span class="img-kuang"><img src="' + pic + '" width="100%" height="100%" type="'+item.mediatype+'" path="'+pic+'" pid="'+item.id+'"><i class="delt-img aui-iconfont aui-icon-move"></i></span>'
						layer.closeAll("loading")
					});
					thisBtn.before(imginfo);
					layer.closeAll("loading")
				},
				error:function(err){
					layer.closeAll("loading")
				}
			});
		}
		$(function(){
			var layer;
			layui.use(['layer'], function(){
			  layer = layui.layer;
			});
			$(".handle-add").on("click",function(){
	            $("#cameraInput").click();
	        });
	        $("#cameraInput").on("change",function(event){
	            var files = event.target.files, file;
	            if (files && files.length > 0) {
	                // 获取目前上传的文件
	                file = files[0];
					formDataUpLoad(file);
	            }
	        });
			//删除添加的图片
			$(".handle").on("click", ".aui-icon-move", function() {
				$(this).parent().fadeOut(function() {
					$(this).remove();
				})
			})
			
			//充值
			$(".chongzhi").on("click", function() {
				confirmzhifu()
				layer.open({
					type: 2,
					title: '在线充值',
					shadeClose: true,
					shade: 0.4,
					area: ['80%', '70%'],
					content: '/qianbao/minichongzhi.html' //iframe的url
				});
			})
			
			
			var typeId = 1;
			//$"#Fruit").val(typeId)
			//浏览图片
			
			$(".handle").on("click", "img", function() {
				var picpath=$(this).attr("path");
				var vtype=$(this).attr("type");
				if (vtype=='video'){
					vadioPlay(picpath)
					return;
				}
				$(".bigpicbox").show()
				var bigpiclist='<img src="'+picpath+'" alt=""/>'
				$(".bigpic").html(bigpiclist)
			});
			
			//选择联系方式是否公开
			$(".see-contact").on("click", "input", function() {
				//alert($(this).val())
				var price_see = $(this).val();
				if (price_see == "1") {
					$(".showcontact").show();
				} else {
					$(".showcontact").hide();
				}
			})
			
			//提交表单
			$(".handle-into").on("click", function() {
				huzhupostsave();
			});
			//获取余额
			getbalance()
		})
		function closeopenpic(){
			$(".bigpicbox").hide()
		}
		//获取余额
		function getbalance(){
			//获得余额
			zzajax("get","/qianbao/qianbaobaoblance.html","",function(ret){
				var blance=ret.blance;
				var showphpne=ret.showphone;
				$(".balancenum").html(blance);
				var showcontactnum=$("#showcontactnum").val();
				if (blance>=parseInt(showcontactnum)){
					$(".nomeny").hide();
				}else{
					$(".nomeny").show();
				}
				//高会或已经购买显示联系方式直接隐藏
				if (showphpne){
					$(".see-contact").hide();
					$(".showcontact").hide();
				}else{
					$(".see-contact").show();
				}
			},function(){
				layer.msg("读取余额错误！")
			})
		}
		//确认支付完成
		function confirmzhifu(){
			var html = "";
			html += '你是否已经完成支付';
			layer.open({
				content: html
				,btn: ['确定', '取消']
				,yes: function(index){
					getbalance();
					layer.close(index);
				}
			});
		}
		//选择付费类型
		function selectshowcontact(obj){
			var balancenum=$(".balancenum").text();
			if (obj.value>parseInt(balancenum)){
				$(".nomeny").show();
			}else{
				$(".nomeny").hide();
			}
		}
		function huzhupostsave(){
			imagesList='';
			var title = $(".title-input input").val();
			var content = $(".text-area textarea").val()
			var category_id=$(".type-into input:checked").val();
			var contact_see = $(".see-contact input:checked").val();
			if (category_id == "" || !category_id) {
				layer.msg("选择你要发布到哪个版块！");
				return;
			}
			//if (title == "") {
			//	hint("您的标题还没填写！");
			//	return;
			//}//
			
			if (content == "") {
				layer.msg("请填写发布的内容！");
				$(".text-area textarea").focus();
				return;
			}
			if (contact_see=="1"){
				if ($(".nomeny").css("display")=="none"){
				}else{
					layer.msg("您的余额不足，请充值！");
					return;
				}
			}
			layer.load(2)
			if (!category_id){
				category_id="106"
			}
			var showcontactnum = $("#showcontactnum").val();
			var contactflag = contact_see;
			//获取图片地址
			$.each($('.img-kuang img'), function(i, item) {
				var picpath=$(this).attr("path");
				var vtype=$(this).attr("type");
				var pid=$(this).attr("pid");
				imagesList+=pid+","
			});
			var data = {
				datatype : "json",
				title : title,
				category_id : category_id,
				content : content,
				source : 'bbs_post',
				showcontactnum : showcontactnum,
				contactflag : contactflag,
				piclist:imagesList,
			};
			//alert(JSON.stringify(data))
			if (postflag==true){
				postflag=false;
				zzajax("post","/huzhupostsave/",data,function(ret){
					if (ret) {
						if (ret.err=='login'){
							window.location="/login/?done={{host}}";
							layer.closeAll('loading');
							return;
						}
						if (ret.err == "false") {
							layer.msg("发布成功！");
							layer.closeAll('loading');
							window.location='/huzhu/';
						} else {
							layer.msg(ret.errkey);
							layer.closeAll('loading');
						}
					} else {
						layer.msg('系统错误，请重试');
					};
					postflag=true;
					layer.closeAll('loading');
				},function(){
					postflag=true;
					layer.msg('系统错误，请重试');
					layer.closeAll('loading');
				});
			}
		}
	</script>
	{%include 'aui/bottom.html'%}
</html>